/*
@name Mutex check without delay
@category Parallel

Adds 1Mk elements to an interlocked array 
as fast as possible.

@long 1010
@checkpoint STEP
@result OK
*/

load rnd

size = 1_000_000
size10 = size/10
size1000 = size/1000
data = [1]
data.reserve(size)
mtx = Mutex()

function process()
   for i = 0 to size10
      
      mtx.lock()
      data += data[-1] + 1
      if i % size1000 == 0
         > "STEP"
      end
      mtx.unlock()
   
   end
end

> "Parallel Mutex test"
functions = [Parallel]
for i = 1 to 10
   functions += process
end
p = functions()
p.launch()

> "Check loop"
for i = 1 to data.len - 1
   if data[i] != data[i-1] + 1
      return "Check failed"
   end
   if i % size10 == 0: > "STEP"
end
return "OK"
