/*
@name Mutex check
@category Parallel

Adds 1M elements to an interlocked array.

@long 1001
@checkpoint STEP
@result OK
*/

load rnd

randomSeed(1024)

data = [1]
mtx = Mutex()

function process()
   for i = 0 to 10000
      if random(1,2) == 1 
         r = random(1,10)
         rest(r)
      end
      
      mtx.lock()
      data += data[-1] + 1
      if data.len % 100 == 0
         > "STEP"
      end
      mtx.unlock()
   
   end
end

> "Parallel Mutex test"
functions = [Parallel]
for i = 1 to 10
   functions += process
end
p = functions()
p.launch()

> "Check loop"
for i = 1 to data.len - 1
   if data[i] != data[i-1] + 1
      return "Check failed"
   end
end

> "STEP"

return "OK"
