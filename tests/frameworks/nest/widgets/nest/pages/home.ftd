<?
   import from nest.js
   import from nest.ajax
   import CheckBoxSet from nest.widgets.CheckBoxSet as CheckBoxSet
   import from nest.widgets.widget in widget

   // for the table
   import InputText from nest.widgets.InputText as InputText
   import Hidden from nest.widgets.Hidden as Hidden
   import Button from nest.widgets.Button as Button
   
   
   Reply.setCookie( "test", "Test value" )
?>
<h1>Hello world!</h1>
<p>JS button utility function test: <? nest.js.button( "Button", "say_hi()" ) ?>.</p>
<?
   // JS Script facility test.
   nest.js.script( "
         function say_hi() {
               alert('saying hi!');
         }" )
?>
<hr>
<p>Ajax basic function test: <? nest.js.button( "Button", "Nest.ajax('hello', {'p0':'A parameter'}, onHello)" ) ?>.</p>
<script language="javascript">
   function onHello( obj ) {
         alert('Received ajax hello: ' + obj.text +
            '\nRepeated parameter: ' + obj.p0 );
   }
</script>
<p>Checking for cookie persistency via ajax: <? nest.js.button( "Button", "Nest.ajax('hello', {}, getCookie)" ) ?>.</p>
<?
   // JS Script facility test.
   nest.js.script( "
         function getCookie( obj ) {
               alert('Cookie data via ajax was: ' + obj.Cookie );
         }" )
?>

<hr>
<p>Nest AJAX enabled widget test.</p>
<?= Nest.widget( "HashMaker" )("hm").render() ?>

<hr>

<p>Basic widgets with local page messaging: Type some text and see the count change.</p>
<?
   wid = Nest.widget( "ActiveTextArea" )("enter_text", "Enter text", 3, 30)

   widtext = Nest.widget("Text")("counter","0")
   widtext.addStyle( "color:red; font-weight:bold" )
   widtext.jsListeners = [
      wid => " function( source, msg, value ) { this.innerHTML = value.length; }"
      ]
?>
<p><?= wid.render() ?></p>
<p>Lenght of the text: <?=widtext.render() ?></p>

<hr>
<p>Advanced widgets with local page messaging</p>
<?= Nest.widget( "RichPassword" )("my_password", "Enter password", "Repeat password").render() ?>
<hr>
<p>Avanced widget with AJAX and local messaging.</p>
<p>Names taken on the server are: <?
   namewid = Nest.widget( "TheNameIsAvail" )()
   > ", ".merge( namewid.takenNames )
?>
</p>
<p>Please, notice that the names must be at least <?= namewid.minSize ?> characters long.</p>
<p><?= namewid.render() ?></p>

<hr>
<p>Form rendering.</p>
<?
   form = Nest.widget( "ListForm" )("testform", "#")

   wid = Nest.widget( "ActiveTextArea" )("enter_text", "Enter text", 3, 30)
   widtext = Nest.widget("Text")("counter","0")
   widtext.addStyle( "color:red; font-weight:bold" )
   widtext.jsListeners = [
      wid => " function( source, msg, value ) { this.innerHTML = value.length; }"
      ]

   th = Nest.widget( "TheNameIsAvail" )( "the_other_name" )
   form.addChild( th )
   form.addChild( Nest.widget( "RichPassword" )("my_password", "Enter password", "Repeat password") )
   form.addChild( wid )
   form.addChild( widtext )
?>

<?= form.render() ?>

<hr>
<p>Form rendering -- table version.</p>
<?
   form = Nest.widget( "TableForm" )("tableform", "#")
   form.addHidden( "hasForm", "true" )

   wid = Nest.widget( "ActiveTextArea" )("enter_text", "Enter text", 3, 30)
   widtext = Nest.widget("Text")("counter","0")
   widtext.addStyle( "color:red; font-weight:bold" )
   widtext.jsListeners = [
      wid => " function( source, msg, value ) { this.innerHTML = value.length; }"
      ]

   th = Nest.widget( "TheNameIsAvail" )( "the_other_name" )
   form.addChild( th )
   form.addChild( Nest.widget( "RichPassword" )("my_password", "Enter password", "Repeat password") )
   form.addChild( wid )
   form.addChild( widtext )
   form.setConfirmReset( "Sure you want to reset?" )
   form.setConfirmSubmit( "Sure you want to submit?" )

   class MyCBSet from CheckBoxSet( "choice",
               ["one:First choice$", "two:Second choice$", "three:Third choice$"])
         
      function setRenderValue( val )
         self.CheckBoxSet.setRenderValue( val )
         if self.value.len() < 2
            self.fieldInfo = "<b>Please, select at least 2 items!</b>"
         end
      end
   end
   cbox = MyCBSet()
   
   cbox.label = "Pick one or more..."
   form.addChild( cbox )

   rbox = Nest.widget( "RadioButtonSet" )( "pick",
               ["one:Alpha", "two:Beta", "three:Gamma"])
   rbox.label = "Hello"
   form.addChild( rbox )

   selbox = Nest.widget( "Select" )( "selopt",
               [ ": -- Pick one plz --", "one:Option One", "two:Option Two", "three:Option Three"],
               "Pick one" )
               
   mselbox = Nest.widget( "Select" )( "selmulti",
               ["one:Option One", "two:Option Two",
                "three:Option Three",
                "four:Option four" ],
                "Pick many", -1 )
   form.addChild( selbox )
   form.addChild( mselbox )

   datesel = Nest.widget( "DateSelector" )( "datesel" )
   form.addChild( datesel )
   
   // bottom line...
   contSub = Nest.widget( "Container" )( "sub" )
   contSub.addChild( Nest.widget("Submit")("sb", "Send data") )
   contSub.addChild( Nest.widget("Reset")("rb", "Reset data") )
   form.addChild( contSub )
   
   if "tableform.hasForm" in Request.posts
      > "Receiving form data from a post"
      form.routeValues( Request.posts )
      if not rbox.getValue()
         rbox.fieldInfo= "<b>Please, set one!</b>"
      end
      datesel.fieldInfo = "You entered " + datesel.getValue()
   end
?>

<?= form.render() ?>

<hr>
<h3>Table test</h3>

<?
   filterText = Nest.widget("ActiveInput" )( "TabNamefilter", "Filter Surname Name" )
   filterText.typeTimeout = 300
   table = Nest.widget( "NameTable" )( "tabtest", 10, -1, 0, 0 )
   table.addFilterWidget( filterText )

   //=================================================================
   // Deletor
   //
   class TableDeletor from widget.Widget( "tabtest.deletor" )
      props = ['style'=>"display:none"]
      jsListeners = [
         table => "
            function( source, msg, value ) {
               if(msg == 'del') {
                  if( window.confirm('delete: ' + value.comment) ) {
                     Nest.ajax( 'DeleteTableRecord', {id:value.key}, function(){Nest.i('tabtest').refresh()} );
                  }
               }
            }"
      ]
   end

   tdeletor = TableDeletor()

   //=================================================================
   // Updater
   //

   class TableUpdater from widget.Widget( "tabtest.updater" )
      props = ['style'=>"display:none"]
      jsListeners = [
         table => "
            function( source, msg, value ) {
               if(msg == 'upd') {
                  this.fetchData(value.key);
               }
            }"
      ]

      jsMethods = [
         "fetchData" => "
            function( id ){
                  Nest.i('tabtest.updater').style.display='none';
                  Nest.ajax( 'GetTableRecord', {\"id\":id}, function(v){Nest.i('tabtest.updater').refresh(v)} );
            }",

         "newData" => "
            function(){
                  Nest.i('tabtest.updater.id').value = -1;
                  Nest.i('tabtest.updater.name').value = '';
                  Nest.i('tabtest.updater.surname').value = '';
                  Nest.i('tabtest.updater.age').value = '';
                  
                  Nest.i('tabtest.updater').style.display='';
            }",
            
         "refresh" => "
            function( data ) {
               Nest.i('tabtest.updater.id').value = data.id;
               Nest.i('tabtest.updater.name').value = data.name;
               Nest.i('tabtest.updater.surname').value = data.sname;
               Nest.i('tabtest.updater.age').value = data.age;
               Nest.i('tabtest.updater').style.display = '';
            }",

         "update_done" => "
            function(){
               var dict = {
                  id: Nest.i('tabtest.updater.id').value,
                  name: Nest.i('tabtest.updater.name').value,
                  sname: Nest.i('tabtest.updater.surname').value,
                  age: Nest.i('tabtest.updater.age').value };

                  Nest.i('tabtest.updater').style.display='none';
                  var func = 'UpdateTableRecord';
                  if( dict.id < 0 ) { func = 'AddTableRecord'; }
                  Nest.ajax( func, dict, function(){Nest.i('tabtest').refresh()} );
            }"
         ]

      init
         self.addChild( Hidden( 'id' ) )
         self.addChild( InputText( 'name', "Name:" ) )
         self.addChild( InputText( 'surname', "Surname:" ) )
         self.addChild( InputText( 'age', "Age:" ) )

         updbtn = Button( 'update', "Update" )
         updbtn.props = [ "onclick" => "Nest.i('tabtest.updater').update_done()" ]
         fgtbtn = Button( 'forget', "Forget it" )
         fgtbtn.props = [ "onclick" => "Nest.i('tabtest.updater').style.display='none'" ]
         
         self.addChild( updbtn )
         self.addChild( fgtbtn )
         
      end
      
   end

   tupd = TableUpdater()

   //=================================================================
   // Multiple deletor
   //
   
   //=================================================================
   // Adder
   //

   tadder = Button( 'tabtest.adder', "Add" )
   tadder.props =[ "onclick" => "Nest.i('tabtest.updater').newData()" ]
   
?>
<?= filterText.render() ?><br/>
<?= table.render() ?>
<?= tadder.render() ?>
<?= tdeletor.render() ?>
<?= tupd.render() ?>

<p><i>Tests complete -- for now</i></p>

