/***************************************************
* Module Name :
* Author      : Lucone
* Create date : 2011-07-05
* Edit by     : --        in date   : ....-..-..
* Module Description -------------------------------
*        <please insert a module description>
***************************************************/
/***************************************************
--Classes, Object and functions:
*	16	class BlogComment( fetchFN, execFN  )
*	32		function finalize()
*	37		function getByBlogID( IDBlog )
***************************************************/
import from nest.dm.cust.DateTimeManagement in DateTime

class BlogComment( dbutility  )
	_dbuti 	 = nil

	ID		 = nil
	IDBlog	 = nil
	Content  = nil
	Date 	 = nil
	Author 	 = nil
	Email  	 = nil
	Website  = nil

	init
		self._dbuti = dbutility
	end

	/*	To free the resources used	*/
	function finalize()
		self._dbuti = nil
	end

	function getListByBlog( IDBlog )
		sqlCmd = "SELECT IDBLOGCOMMENTS, Content, Author, email, website, Date, IDBLOG FROM tBlogComments WHERE IDBLOG = ?;"

		aRec = self._dbuti.fetchDict( sqlCmd, IDBlog )
		ret  = []

		// Retrieving tags
		for b in aRec

			comment = BlogComment()
			comment.ID		 = b[ "IDBLOGCOMMENTS" ]
			comment.IDBlog	 = b[ "IDBLOG" ]
			comment.Content  = b[ "Content" ]
			t = TimeStamp()
			t.fromLongFormat(b[ "Date" ])
			comment.Date 	 = t
			comment.Author 	 = b[ "Author" ]
			comment.Email  	 = b[ "email" ]
			comment.Website  = b[ "website" ]

			ret += comment

		end
		
		return ret

	end
	
	function postedBy()
		sRet = i"Posted by "
		
		if self.Website
			sRet += @"<a rel='nofollow' href='$(self.Website)' target='blank'>$(self.Author)</a>"
		elif self.Email
			sRet += @"<a rel='nofollow' href='mailto:$(self.Email)'>$(self.Author)</a>"
		else
			sRet += self.Author
		end
				
		nameDay   = DateTime.dayNames[ self.Date.dayOfWeek() ]
		numDay    = self.Date.day
		nameMonth = DateTime.monthNames[ self.Date.month -1 ]
		hour = "0" + self.Date.hour
		minute = "0" + self.Date.minute
		
		hour = hour[-2:]
		minute = minute[-2:]
		sRet +=  @", $(nameDay), $(nameMonth) $(numDay), $(self.Date.year) at $(hour):$(minute)"
			
		
		return sRet
	end

// subRegion: Insert, Update and Delete
	function insert( Content, Author, email, website, IDBlog )		
		return self._dbuti.execute("INSERT INTO tBlogComments (Content, Author, email, website, Date, IDBLOG) VALUES(?, ?, ?, ?, ?, ?);", \
						[Content, Author, email, website, CurrentTime().toLongFormat(), IDBlog])

	end

	function update( IDComment, Content, Author, email, website, IDBlog )
		sqlCMD = "
					UPDATE tBlogComments
						SET
						    Content = ?,
						    Author = ?,
						    email = ?,
						    website = ?,
						    Date = ?,
						    IDBLOG = ?,
					WHERE
							IDBLOGCOMMENTS = ?;"
		
		return self._dbuti.execute( sqlCMD, \
						[Content, Author, email, website, CurrentTime().toLongFormat(), IDBlog, IDComment])

	end
		
	function delete( IDComment )
		return self._dbuti.execute("DELETE FROM tBlogComments WHERE IDBLOGCOMMENTS = ?;", IDComment)
	end
end