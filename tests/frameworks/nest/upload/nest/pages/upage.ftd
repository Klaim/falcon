<?
   import from nest.action in na

   // As this is a test, we need to create and check our working environment.
   targetDir = "uploads"
   if fileType( targetDir ) != FileStat.DIR
      try
         dirMake( targetDir )
         fileChmod( targetDir, 0755 )
      catch IoError
         > "Cannot create test directory "+ targetDir + "<br/>"
         > "Please, select another directory or make the directory where index.fal resides writable."
      end
   end

   config = [
      "upload_dir" => targetDir
      ]

   config["actions"] = .[
      na.LinkAction( Nest.AL.NONE, i"View", "javascript:viewFile('$$file','$$path');" )
   ]

   if "wnd" in Request.gets
      config["actions"] += na.LinkAction( Nest.AL.NONE, i"Select", "javascript:choseFile('$$file','$$path');" )
   end

   s = Nest.service( "Uploader", "", config )
   // We run nest here, so that the configuration is reaed before we start the page
   Nest.run()
?>
<html>
<head>
   <title>Upload a file</title>
   <?= Nest.headings() ?>

<script type="text/javascript">
   function viewFile( name, path )
   {
      window.open( "<?=targetDir ?>/" + path + "/" + name, "View file " + name);
   }

   function choseFile( name, path )
   {
      window.opener.focus();
      window.opener.insertText( "{You have chosen " + name + " from " + path + "}"  );
      window.close();
   }   
</script>
</head>
<body>
<h1>Upload file</h1>
<p>Service configured to write files in <?= s.upload_dir.value ?>.</p>
<div>
   <?= s.render() ?>
</div>
</body>
</html>
