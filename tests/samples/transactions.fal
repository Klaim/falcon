load dbi
load sample_db

function showNames(title, d)
	> title, ":"
   > "=================================================="
	r = d.query( "SELECT name, dob FROM names ORDER BY name" )
   while ( let n = r.fetchArray() )
   	> n[0], " was born on ", n[1]
   end
   r.close()
   >
end

d = connect()
createNamesTable(d)

showNames("Before any alteration", d)

tr = d.startTransaction()
tr.execute( "INSERT INTO names (name, dob) VALUES ($1, $2)", "Jim", "2007-12-25" )
tr.close() // automatically commits()

showNames( "After insertion of Jim", d)

tr = d.startTransaction()
tr.execute( "INSERT INTO names (name, dob) VALUES ($1, $2)", "Jack", "2007-12-25" )
tr.rollback()
tr.close()

showNames( "After insertion of Jack but with rollback", d)

tr = d.startTransaction()
try
	tr.execute( "INSERT INTO names (name, dob VALUES ($1, $2)", "Julie", "1982-01-03" )
catch DBIError in err
	tr.rollback()
end
tr.close()

showNames( "After insertion if Julie but with bad SQL and rollback in catch", d )

dropNamesTable(d)
d.close()
