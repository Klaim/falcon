/*
@name Cleanup with error
@category Core-funcs

This test checks for correct cleanup sequence when
the program terminates with an error being thrown.

@output
Cleanup test (with error)
============================================================
CL2: Data from main
CL1: Changed from CL2
CL0: Changed from CL1
Caught error was:24
@endoutput
*/

> "Cleanup test (with error)"

data = "Data from main"

VMProcess.current.pushCleanup( cl0 )
VMProcess.current.pushCleanup( cl1 )
VMProcess.current.pushCleanup( cl2 )

> "=" * 60

raise "Uncaught!"

// this shall not be printed
> "Done."

function cl0()
   global data
   > "CL0: ", data
   data = "Changed from CL0"
   > "Caught error was:", VMProcess.current.error.code
   /*
   > "=" * 60
   
   > "=" * 60
   */
   // force exit ignoring the error.
   VMProcess.current.clearError()
end

function cl1()
   global data
   > "CL1: ", data
   data = "Changed from CL1"
end

function cl2()
   global data
   > "CL2: ", data
   data = "Changed from CL2"
end
