/****************************************************************************
* Falcon test suite -- DBI tests
*
*
* ID: 21c
* Category: mysql
* Subcategory:
* Short: MySQL query multiple
* Description:
* Performs a simple query that should return 10 records
*  -- USES the table created by the first test and the data from test 20d
* [/Description]
*
****************************************************************************/

import from dbi
import mysql_conn_str from config

data = []
for i in [0:10]
   mb = MemBuf(10)
   for j = 0 to 9: mb[j] = (j+i+65)
   t = CurrentTime()
   t.second = i
   data += [[ 0, i+10, "fix char " + i, "varchar " + i,
         "Text blob " + i, mb,
         24589.21345/(i+1), t ]]
end

try
   conn = dbi.connect( config.mysql_conn_str )
   rs = conn.query( "
      select kv, vint, fixchar, vchar, tblob, bblob, number, ts
      from TestTable where vint >= ? and vint < ?",
      10, 20 )

   if rs.getColumnCount() != 8
      failure( "Can't get columns: " + rs.getColumnCount() )
   end

   if rs.getRowCount() != 10
      failure( "Can't get row count: " + rs.getRowCount() )
   end

   // fetch array
   arr = []
   count = 0
   while rs.fetch( arr )
      if arr[1] != data[count][1] or arr[2] != data[count][2] or \
            arr[3] != data[count][3] or arr[6] != data[count][6] or \
            arr[7].year != data[count][7].year
         failure( "Consistency check at step " + count )
      end
      ++count
   end

   if count != 10
      failure( "Fetched records " + count )
   end

   rs.close()
   conn.close()
   success()

catch dbi.DBIError in error
   failure( "Received a DBI error: " + error )
end
