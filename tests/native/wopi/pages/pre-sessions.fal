load timestamp
import session

// determine what we want to do.
mode = Request.getField( "mode", "" )

try
   Wopi.session(&session)
   
catch Error in e
   status = "Invalid or expired session ID: " + e.toString()
end

switch mode
   case "login"
      // a very simple auth scheme:
      if Request.getField( "user", "" ) == "master" and Request.getField( "pwd", "" ) == "1234"
         session = .[ 
            "user" => "master"
            "times" => 0
            "international" => "国際記録物"
            "started" => TimeStamp().current()
            ]

         // All right.
         status = nil
      else
         status = "Login error"
      end

   case "logout"
      Wopi.closeSession()
      session = nil

   default
      // no mode? -- if we're logged in we must update the times counter.
      if "times" in session
         session["times"]++
      end
end

return [session, mode, status]
